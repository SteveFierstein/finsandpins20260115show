<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fins and Pins - Click to Claim (Version 2.1)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background: #f5f5f5;
    }

    h1 {
        text-align: center;
        margin-bottom: 4px;
        font-size: 26px;
    }

    h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 16px;
        color: #444;
        font-weight: normal;
    }

    #globalCounts {
        text-align: center;
        font-size: 18px;
        margin-bottom: 20px;
        font-weight: bold;
    }

    .board-container {
        margin-bottom: 40px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .board-title {
        font-size: 20px;
        margin-bottom: 6px;
        font-weight: bold;
    }

    .board-count {
        font-size: 16px;
        margin-bottom: 8px;
        color: #333;
    }

    .board-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: auto;
    }

    .board-img {
        width: 100%;
        display: block;
        border-radius: 6px;
    }

    .pin {
        position: absolute;
        border-radius: 6px;
        border: none;
        background: transparent;
        box-sizing: border-box;
    }

    .pin.claimed {
        border: 4px solid rgba(0, 128, 0, 0.9);
        background: rgba(0, 255, 0, 0.20);
    }

    .pin .checkmark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: black;
        opacity: 0.9;
        pointer-events: none;
        display: none;
        line-height: 1;
    }

    .pin.pulled .checkmark {
        display: block;
    }

    #footerControls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin: 20px 0 10px 0;
    }

    #modeLabel {
        margin-right: 10px;
        font-size: 14px;
        color: #333;
    }

    #modeToggleButton {
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #333;
        background: #ffffff;
        cursor: pointer;
    }

    #modeToggleButton.pull-mode {
        background: #ffe9c6;
        border-color: #cc8400;
    }

    #modeToggleButton.claim-mode {
        background: #e6f7ff;
        border-color: #0066aa;
    }
</style>
</head>

<body>

<h1>Welcome to the Click-to-Claim page of Fins and Pins</h1>
<h2 id="showTitle">Loading…</h2>

<div id="globalCounts">Loading counts…</div>

<div id="footerControls" style="display:none;">
    <div id="modeLabel">Mode: Claim (Lexi)</div>
    <button id="modeToggleButton" class="claim-mode">
        Pull Mode (PinDad Only)
    </button>
</div>

<script>
// ------------------------------------------------------------
// AUTO-GENERATE SHOW NAME FROM FOLDER
// ------------------------------------------------------------
(function() {
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const folder = pathParts[pathParts.length - 1] || "Show";

    // Try to detect YYYYMMDD inside folder name
    const dateMatch = folder.match(/(20\d{6})/);

    let finalName = folder;

    if (dateMatch) {
        const raw = dateMatch[1]; // e.g., 20260112
        const year = raw.substring(0, 4);
        const month = raw.substring(4, 6);
        const day = raw.substring(6, 8);

        const dateObj = new Date(`${year}-${month}-${day}`);
        const monthName = dateObj.toLocaleString("en-US", { month: "long" });

        finalName = `${monthName} ${parseInt(day)} Show`;
    }

    document.getElementById("showTitle").textContent = finalName;
})();

// ------------------------------------------------------------
// SHOW-SPECIFIC STORAGE
// ------------------------------------------------------------
const pathParts2 = window.location.pathname.split("/").filter(Boolean);
const showName = pathParts2[pathParts2.length - 1] || "default";

function loadSelections(boardName, type) {
    const key = `pinSelections-${showName}-${boardName}-${type}`;
    return JSON.parse(localStorage.getItem(key) || "[]");
}

function saveSelections(boardName, type, arr) {
    const key = `pinSelections-${showName}-${boardName}-${type}`;
    localStorage.setItem(key, JSON.stringify(arr));
}

// ------------------------------------------------------------
// STATE
// ------------------------------------------------------------
let currentMode = "claim";

let boardsState = {};
let globalTotals = {
    totalPins: 0,
    claimed: 0,
    pulled: 0
};

// ------------------------------------------------------------
// MODE TOGGLE UI
// ------------------------------------------------------------
const footerControls = document.getElementById("footerControls");
const modeLabel = document.getElementById("modeLabel");
const modeToggleButton = document.getElementById("modeToggleButton");

function updateModeUI() {
    if (currentMode === "claim") {
        modeLabel.textContent = "Mode: Claim (Lexi)";
        modeToggleButton.textContent = "Switch to Pull Mode (PinDad Only)";
        modeToggleButton.classList.remove("pull-mode");
        modeToggleButton.classList.add("claim-mode");
    } else {
        modeLabel.textContent = "Mode: Pull (PinDad Only)";
        modeToggleButton.textContent = "Switch to Claim Mode (Lexi)";
        modeToggleButton.classList.remove("claim-mode");
        modeToggleButton.classList.add("pull-mode");
    }
}

modeToggleButton.addEventListener("click", () => {
    if (currentMode === "claim") {
        const ok = window.confirm(
            "Switch to Pull Mode?\n\nThis mode is for confirming pins you’ve physically pulled."
        );
        if (!ok) return;
        currentMode = "pull";
    } else {
        const ok = window.confirm(
            "Switch back to Claim Mode (Lexi)?\n\nThis mode is for marking pins as claimed."
        );
        if (!ok) return;
        currentMode = "claim";
    }
    updateModeUI();
});

// ------------------------------------------------------------
// LOAD MANIFEST AND BUILD BOARDS
// ------------------------------------------------------------
fetch("./boards/manifest.json")
    .then(r => r.json())
    .then(boardList => {
        boardList.forEach(boardName => {
            createBoard(boardName);
        });

        footerControls.style.display = "flex";
        updateGlobalCounts();
    });

function createBoard(boardName) {
    const container = document.createElement("div");
    container.className = "board-container";

    const title = document.createElement("div");
    title.className = "board-title";
    title.textContent = boardName;
    container.appendChild(title);

    const countDiv = document.createElement("div");
    countDiv.className = "board-count";
    countDiv.id = `count-${boardName}`;
    countDiv.textContent = "Pins: 0 — Claimed: 0 — Pulled: 0";
    container.appendChild(countDiv);

    const wrapper = document.createElement("div");
    wrapper.className = "board-wrapper";

    const img = document.createElement("img");
    img.className = "board-img";
    img.loading = "lazy";
    img.src = `./boards/${boardName}.jpeg`;

    wrapper.appendChild(img);
    container.appendChild(wrapper);
    document.body.insertBefore(container, footerControls);

    boardsState[boardName] = {
        totalPins: 0,
        claimed: [],
        pulled: [],
        countDiv: countDiv
    };

    fetch(`./boards/${boardName}.json`)
        .then(r => r.json())
        .then(data => {
            const pins = data.output?.predictions || [];
            const totalPins = pins.length;

            boardsState[boardName].totalPins = totalPins;
            globalTotals.totalPins += totalPins;

            let claimedSelections = loadSelections(boardName, "claimed");
            let pulledSelections = loadSelections(boardName, "pulled");
            boardsState[boardName].claimed = claimedSelections.slice();
            boardsState[boardName].pulled = pulledSelections.slice();

            updateBoardCount(boardName);

            img.onload = () => {
                const ORIGINAL_WIDTH = img.naturalWidth;
                const displayedWidth = img.clientWidth;
                const scale = displayedWidth / ORIGINAL_WIDTH;

                pins.forEach((pin, index) => {
                    const div = document.createElement("div");
                    div.className = "pin";

                    const left = (pin.x - pin.width / 2) * scale;
                    const top = (pin.y - pin.height / 2) * scale;
                    const width = pin.width * scale;
                    const height = pin.height * scale;

                    div.style.left = left + "px";
                    div.style.top = top + "px";
                    div.style.width = width + "px";
                    div.style.height = height + "px";

                    div.style.fontSize = (height * 0.6) + "px";

                    const check = document.createElement("span");
                    check.className = "checkmark";
                    check.textContent = "✓";
                    div.appendChild(check);

                    if (claimedSelections.includes(index)) {
                        div.classList.add("claimed");
                    }
                    if (pulledSelections.includes(index)) {
                        div.classList.add("pulled");
                    }

                    div.addEventListener("click", () => {
                        handlePinClick(boardName, index, div);
                    });

                    wrapper.appendChild(div);
                });

                updateGlobalCounts();
            };
        });
}

// ------------------------------------------------------------
// PIN CLICK HANDLING
// ------------------------------------------------------------
function handlePinClick(boardName, pinIndex, pinDiv) {
    const state = boardsState[boardName];
    if (!state) return;

    if (currentMode === "claim") {
        const isClaimed = pinDiv.classList.toggle("claimed");
        if (isClaimed) {
            if (!state.claimed.includes(pinIndex)) {
                state.claimed.push(pinIndex);
            }
        } else {
            state.claimed = state.claimed.filter(i => i !== pinIndex);
        }
        saveSelections(boardName, "claimed", state.claimed);
    } else {
        const isPulled = pinDiv.classList.toggle("pulled");
        if (isPulled) {
            if (!state.pulled.includes(pinIndex)) {
                state.pulled.push(pinIndex);
            }
        } else {
            state.pulled = state.pulled.filter(i => i !== pinIndex);
        }
        saveSelections(boardName, "pulled", state.pulled);
    }

    updateBoardCount(boardName);
    updateGlobalCounts();
}

// ------------------------------------------------------------
// COUNT UPDATES
// ------------------------------------------------------------
function updateBoardCount(boardName) {
    const state = boardsState[boardName];
    if (!state) return;

    const claimed = state.claimed.length;
    const pulled = state.pulled.length;

    state.countDiv.textContent =
        `Pins: ${state.totalPins} — Claimed: ${claimed} — Pulled: ${pulled}`;
}

function updateGlobalCounts() {
    let claimed = 0;
    let pulled = 0;

    Object.values(boardsState).forEach(state => {
        claimed += state.claimed.length;
        pulled += state.pulled.length;
    });

    globalTotals.claimed = claimed;
    globalTotals.pulled = pulled;

    document.getElementById("globalCounts").textContent =
        `Total Pins: ${globalTotals.totalPins} — Claimed: ${claimed} — Pulled: ${pulled}`;
}
</script>

</body>
</html>
